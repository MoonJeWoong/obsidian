---
Title: 다중 서버 환경에서 그라파나 로키를 이용해 로깅하기
tags:
  - 포스팅
---
(서버 Scale Out에 따른 구조도 그림 제시)

# LogQL : Log Query Language

LogQL은 그라파나 로키의 PromQL-Inspired 쿼리 언어입니다. 작성한 쿼리들은 각 로그 소스들을 통합하기 위해서, 마치 grep 명령어를 각 로그 소스들을 대상으로 분산처리하는 것과 같이 동작하게 됩니다. LogQL은 필터링을 위해 label과 operator를 사용합니다. 

LogQL 쿼리의 종류에는 다음과 같은 2가지 종류가 있습니다.
- Log Queries : 로그 라인들의 내용을 반환합니다.
- Metric Queries : 쿼리 결과에 기반을 두고 추가적으로 값을 계산해서 Log Query를 확장하는 개념의 쿼리입니다.

저희는 각 서버에 저장된 로그 데이터를 그대로 출력하는 것이 목표이기 때문에 Log Queries를 좀 더 알아보면 될 것 같습니다.


# Log Queries

모든 LogQL 쿼리들은 작성될 때 log stream selector를 포함합니다. stream selector는 여러 로그 스트림들 중 어떤 스트림이 쿼리 결과에 포함될지를 결정합니다. 로그 스트림은 로깅 파일과 같이 로그 내용이 담겨있는 고유한 출처를 의미하는데 stream selector를 통해서 발견된 여러 스트림 중 필요한 스트림을 선택할 수 있습니다. 너무 많은 스트림이 존재하는 경우 쿼리의 성능을 위해 stream selector에 적절한 label을 지정할 수도 있습니다.

log stream selector는 ,(comma)로 분리된 여러 쌍의 키 - 값 형태로 명시됩니다. 그리고 이 여러 쌍의 키 - 값 데이터들을 { } 로 감싸서 stream selector를 구분합니다.

``` logql
{app="mysql",name="mysql-backup"}
```

위 예제의 log stream selector는 모든 로그 스트림들 중에서 명시된 키 - 값의 label들을 가지는 스트림들만 쿼리 결과에 포함시키게 됩니다. 여기에서 = 연산자는 label matching 연산자입니다. log stream selector에서는 다음과 같은 label matching 연산자들을 지원합니다.

- = : 정확하게 일치
- != : 일치하지 않음
- =~ : 정규식에 부합함
- !~ : 정규식에 부합하지 않음

공식 문서에 소개된 정규식 관련 연산자 예제는 다음과 같습니다.
``` logql
{name =~ "mysql.+"}  // mysql 이후 어떤 문자가 하나 이상 오는 문자열을 모두 포함 
{name !~ "mysql.+"}  // mysql 이후 어떤 문자가 하나 이상 오는 문자열을 모두 미포함
{name !~ `mysql-\d+`}  // mysql 이후 하이픈 + 한자리 이상의 숫자가 오는 문자열을 모두 미포함
```



# 기존 자동 생성된 Log Query 수정하기

서버 Scale Out 이전에 그라파나에서 사용하던 자동 생성된 쿼리는 다음과 같았습니다.

```
{job="production_http_log"} |= ``
```

해당 log stream selector는 job label의 값이 "production_http_log"인 로그 스트림만 쿼리 결과에 보여주도록 하고 있습니다. 위에서 살펴봤던 대로 이 log stream selector에 명시된 label에서 정규식을 사용하도록 하면 저희가 원하는 대로 여러 서버에서 다르게 수집되는 로그 스트림들을 같이 조회할 수 있을 것 같습니다.

현재 저희 프로젝트 서버를 Scale Out 하고 난 뒤 검색되는 로그 스트림 현황은 다음과 같습니다. 
(production1 수정하고 그라파나 job 목록 캡처하기)

여기에서 보여지는 job 이름들은 각 서버 로컬에서 프롬테일을 실행할 때 사용하는 설정 파일에 명시되어 있습니다.
(promtail 로컬 ls 캡처하기)
(promtail.yml 캡처하기)

따라서 저희는 production1, production2에 각각 기록되어 들어오는 로그 스트림을 함께 조회하고 싶으므로 다음과 같은 정규식이 포함된 log stream selector를 작성했습니다.
``` LogQL
{job=~"production[12]?_http_log"}
```


(정상적으로 로그 데이터가 통합되는 이미지)

이렇게 각 로그 패널 별로 production1, production2의 로그 스트림을 통합해서 보여주도록 함으로서 다시 하나의 패널에서 여러 서버로 분산 처리되어 기록되는 로그를 확인할 수 있게 되었습니다. 


---
Reference
- https://grafana.com/docs/loki/latest/query/
- https://grafana.com/docs/loki/latest/query/log_queries/#log-stream-selector