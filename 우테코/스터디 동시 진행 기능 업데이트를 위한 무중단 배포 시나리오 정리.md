# 하루스터디 동시 진행 기능 무중단 배포 과정 설계

고려해야할 점
- 프론트 정적 파일들
- WAS
- DB 스키마 변경 (참여코드 만료 + 폴링 기능으로 인한 도메인 변경사항 반영해야 함)


잘 알려진 무중단 배포방식들이 있는데 우리는 블루 그린 배포를 사용한다.
블루 그린을 하면서 고려해야할 문제상황이 있나?

이전 블루 버전의 서버를 통해 스터디를 진행하던 사람들은 서비스 이용 도중에 갑자기 그린서버가 배포되어 사용되기 시작하면 기존 블루 버전 서비스에서 요청하던 사람들은 다 오류가 발생하고 진행이 불가능해진다.

따라서 그린 서버 배포 후 트래픽을 넣어주기 전에 기존 서비스를 사용하던 사람들은 어떻게 해당 서비스를 끝까지 오류 없이 사용할 수 있도록 하게 할 수 있을지?



핵심 문제상황
폴링을 통한 스터디 동시 진행 기능이 추가되면서 사용자 별 서비스 버전 차이로 인한 오류 상황들을 방지하고 사용자로 하여금 배포 과정에서 의도치 않은 불편함을 경험하지 않도록 무중단 배포 과정을 설계한다.


![[Pasted image 20231013174204.png]]

| 프론트엔드                                                                  | 백엔드                                                                        |
|:--------------------------------------------------------------------------- |:----------------------------------------------------------------------------- |
| 1. 스터디 생성, 참여 버튼을 비활성한 프론트 파일 배포 (V1 -> V1.5)          | -                                                                             |
| -                                                                           | 1. 기존 DB 서버(V1) 복제 및 V2 DB로 데이터 마이그레이션                       |
| -                                                                           | 2. 기존 DB 서버(V1)에 추가되는 신규 데이터 V2 DB로 마이그레이션 스케쥴링 시작 |
| -                                                                           | 3. 백엔드 그린 서버 배포 후 V2 DB와 연동 (라우팅은 X)                         |
| 24시간 대기                                                                 | 24시간 대기                                                                   |
| 2. 그린 서버 API를 사용하는 프론트 V2 버전 배포 (기존 V1.5는 유지한 상태로) | 4. Nginx 서버에서 사용자 요청을 프론트 V2 버전 배포 파일에 라우팅되도록 설정  |
| -                                                                           | 5. V1 WAS로 24시간 이상 트레픽이 발생하지 않을 때 까지 유지                   |
| -                                                                           | 6. 이후 기존 프론트 V1.5 파일 제거                                            |
| -                                                                            | 7. 기존 블루 서버에 해당하는 WAS와 DB를 V2로 업데이트                         |

### V1.5를 거쳐가는 이유
- 기존 V1 서비스 페이지의 사용자들이 업데이트 되지 않은 상태로 V2의 폴링 방식 스터디에 참여하는 경우를 방지하기 위해 24시간 대기
- 기존 V1 서비스에서 스터디를 진행하고 있던 사람들은 스터디를 마무리하면 메인으로 돌아가 V1.5로 업데이트 될 것이다.
	- 극히 특수한 경우를 제외하면 24시간 텀을 두었을 때, V1 서비스에서 스터디를 진행하던 사용자들의 브라우저에서 모두 V1.5로 업데이트 될 것이다. 
- 결과적으로 V1.5와 V2가 혼재하게 되는 시점에서 V1 서비스를 사용하고 있는 사용자는 없을 것이라 상정.


### V1.5와 V2가 혼재할 때 예상되었던 문제
- V1.5 서비스에서 혼자하기 기능은 내부적으로 함께하기 기능과 동일한 API를 사용한다. V1.5 서비스에서 혼자 스터디를 진행하던 사용자는 갑자기 V2로 서비스가 업데이트 되면 요청하던 API 서버가 바뀌는데 오류가 발생하지 않을까?
	- 기존 V1.5 서비스에서 혼자하기 스터디를 진행하던 사람들은 프론트 정적 파일에 명시된 V1의 API를 사용할 것이다. 이를 문제없이 처리해주기 위해 그린서버에 V2 서비스를 배포하고 Nginx 라우팅까지 완료하더라도, 기존 V1 API를 처리하기 위한 nginx 라우팅 설정과 V1 서비스 WAS와 DB는 일정 기간 유지해야 한다.
	- V2 배포 완료 이후 V1 서비스 WAS와 DB 유지 기간은 로그를 조회하며 실제로 24시간 이상 사용자의 트레픽이 발생하지 않을 때 모든 사용자가 V2로 업데이트 되었다고 판단하고 V1 WAS와 DB를 제거한다.


한계점
- V1 버전 서비스에서 메인화면에 24시간 이상 머무르던 사람은 에러 상황을 겪을 수 있다.